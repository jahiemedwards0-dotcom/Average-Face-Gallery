<script>
    function getParam(name){
      return new URLSearchParams(window.location.search).get(name)
    }

    const id = getParam('id')
    const morph = (window.MORPHS || []).find(m => m.id === id)

    const titleEl = document.getElementById('title')
    const badgesEl = document.getElementById('badges')
    const imgEl = document.getElementById('img')
    const tagsEl = document.getElementById('tags')
    const notesEl = document.getElementById('notes')
    const sourcesEl = document.getElementById('sources')
    const mapEl = document.getElementById('detail-map')

    if(!morph){
      titleEl.textContent = 'Not found'
      notesEl.innerHTML = '<p>This morph could not be found. Check the link or return to the gallery.</p>'
    } else {
      document.title = morph.title + " â€“ Human Morph Gallery"
      titleEl.textContent = morph.title

      const loc = morph.country || morph.region
      const macro = morph.macro || ''
      badgesEl.innerHTML = `
        ${loc ? `<span class="pill">${loc}</span>` : ''}
        ${macro ? `<span class="pill">${macro}</span>` : ''}
        <span class="pill">${morph.category}</span>
      `

      imgEl.src = morph.img
      imgEl.alt = morph.title

      tagsEl.innerHTML = (morph.tags || [])
        .map(t => `<span class="chip">${t}</span>`).join('')

      notesEl.innerHTML = morph.notes || ''

      sourcesEl.innerHTML = (morph.sources || [])
        .map(s => {
          if(s.url){
            return `<li><a href="${s.url}" target="_blank" rel="noopener">${s.label}</a></li>`
          }
          return `<li>${s.label}</li>`
        }).join('')

      // --- MAP INITIALIZATION ---
      if (morph.lat !== undefined && morph.lng !== undefined) {
        mapEl.style.display = 'block';
        const map = L.map('detail-map').setView([morph.lat, morph.lng], 4);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        // Check if the data has a specific polygon shape (like Sinaloid)
        if (morph.regionPolygon) {
          L.polygon(morph.regionPolygon, {
            color: '#fde047',      // Yellow border mimicking your image
            fillColor: '#fef08a',  // Yellow fill
            fillOpacity: 0.5,
            weight: 2
          }).addTo(map);
          
          // Adjust map view to fit the entire polygon shape
          map.fitBounds(L.polygon(morph.regionPolygon).getBounds());
          
        } else {
          // Fallback to circular highlight if no polygon exists
          L.circle([morph.lat, morph.lng], {
            color: '#7aa2ff',
            fillColor: '#7aa2ff',
            fillOpacity: 0.2,
            radius: 250000
          }).addTo(map);
          L.marker([morph.lat, morph.lng]).addTo(map);
        }
      }
    }
  </script>
